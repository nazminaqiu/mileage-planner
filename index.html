<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mileage Claim Planner</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #0d6efd;
            --accent-hover: #0b5ed7;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --border-color: #495057;
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .theme-toggle:hover {
            background: var(--border-color);
        }

        .section {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .subsection-title {
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }


        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-success {
            background: rgba(25, 135, 84, 0.1);
            color: var(--success-color);
        }

        .status-error {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }
        
        input:disabled {
            background-color: var(--bg-tertiary);
            cursor: not-allowed;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:disabled {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #157347;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border-color);
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: #000;
        }
        .btn-warning:hover:not(:disabled) {
            background: #ffca2c;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #bb2d3b;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .site-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .site-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .site-info {
            flex: 1;
        }

        .site-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .site-address {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .site-distance {
            font-size: 14px;
            color: var(--accent-color);
            font-weight: 500;
        }

        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .day-allocation {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }

        .day-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .trip-input {
            width: 100%;
            padding: 6px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .summary-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--success-color);
            transition: width 0.3s;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-info {
            background: rgba(13, 110, 253, 0.1);
            color: var(--accent-color);
            border-left: 4px solid var(--accent-color);
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }

        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-tertiary);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .autocomplete-dropdown {
            position: absolute;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            margin-top: 4px;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid var(--border-color);
        }

        .autocomplete-item:hover {
            background: var(--bg-secondary);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .position-relative {
            position: relative;
        }
        
        .remove-site-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 24px;
            text-align: center;
        }
        .remove-site-btn:hover {
            background: #bb2d3b;
        }
        
        .claim-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .claim-table th, .claim-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
        .claim-table th {
            font-weight: 600;
            background-color: var(--bg-secondary);
        }
        .claim-table tr:last-child td {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 12px;
            }

            .input-group {
                grid-template-columns: 1fr;
            }

            .allocation-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Mileage Claim Planner</h1>
            <button id="themeToggleBtn" class="theme-toggle">üåô Toggle Theme</button>
        </div>

        <!-- API Status -->
        <div id="apiStatus" class="section">
            <div class="section-title">
                API Status
                <span id="apiStatusBadge" class="status-badge">Waiting for API Key</span>
            </div>
            <div id="apiKeyInput" style="display: block;">
                <div class="alert alert-info">
                    Please enter your Google Maps API Key to get started. Your key will be saved securely in your browser.
                </div>
                <div class="form-group">
                    <label>Google Maps API Key</label>
                    <input type="text" id="apiKeyField" placeholder="Enter your API key here">
                </div>
                <button id="validateApiKeyBtn" class="btn btn-primary">üîë Validate & Save API Key</button>
                <button id="apiKeyHelpBtn" class="btn btn-secondary">‚ùì How to get API Key</button>
            </div>
            <div id="apiMessage" class="alert alert-info" style="display: none;">
                Validating Google Maps API...
            </div>
        </div>

        <!-- Configuration -->
        <div class="section">
            <div class="section-title">‚öôÔ∏è Configuration</div>
            
            <div class="form-group position-relative">
                <label>Start Point (Main Office)</label>
                <input type="text" id="startPoint" placeholder="Enter your office address or use GPS">
                <div id="startPointDropdown" class="autocomplete-dropdown" style="display: none;"></div>
            </div>
            
            <div class="btn-group">
                <button id="useGpsBtn" class="btn btn-secondary">üìç Use Current GPS Location</button>
            </div>

            <div class="input-group">
                <div class="form-group">
                    <label>Mileage Rate (RM/km)</label>
                    <input type="number" id="mileageRate" value="0.80" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Target Amount (RM)</label>
                    <input type="number" id="targetAmount" value="0" step="0.01" min="0">
                </div>
            </div>

            <div class="form-group">
                <label>Date Range</label>
                <input type="text" id="dateRange" placeholder="Select date range">
            </div>

            <div class="form-group">
                <label>Include Weekends</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeSaturday">
                        <span>Saturday</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeSunday">
                        <span>Sunday</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Add Site -->
        <div class="section">
            <div class="section-title">üìç Add Project Site</div>
            
            <div class="form-group">
                <label>Site Name</label>
                <input type="text" id="siteName" placeholder="e.g., Project Site A">
            </div>

            <div class="form-group position-relative">
                <label>Site Address</label>
                <input type="text" id="siteAddress" placeholder="Start typing to search...">
                <div id="siteAddressDropdown" class="autocomplete-dropdown" style="display: none;"></div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="isSingleTripCheckbox">
                        <span>Single Trip Only (within date range)</span>
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label>Project Keywords (optional for description generator)</label>
                <input type="text" id="siteKeywords" placeholder="e.g., Kaseya VSA, network upgrade, server maintenance">
            </div>

            <button id="addSiteBtn" class="btn btn-primary">‚ûï Add Site</button>
        </div>

        <!-- Sites List -->
        <div class="section">
            <div class="section-title">üìã Project Sites</div>
            <div id="sitesList"></div>
        </div>

        <!-- Allocation -->
        <div class="section">
            <div class="section-title">üéØ Smart Allocation</div>
            <div id="allocationAlert" style="display: none;"></div>
            <div class="btn-group">
                <button id="autoAllocateBtn" class="btn btn-success">‚ú® Auto Allocate</button>
                <button id="clearAllocationBtn" class="btn btn-secondary">üóëÔ∏è Clear All</button>
                <button id="meetTargetBtn" class="btn btn-warning" disabled>üéØ Meet Target</button>
            </div>
        </div>

        <!-- Summary -->
        <div class="section">
            <div class="section-title">üìä Summary</div>
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-label">Total Distance</div>
                    <div class="summary-value" id="totalDistance">0 km</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Total Amount</div>
                    <div class="summary-value" id="totalAmount">RM 0.00</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Target Amount</div>
                    <div class="summary-value" id="targetDisplay">RM 0.00</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Progress</div>
                    <div class="summary-value" id="progressPercent">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Overtime & Work Description Generator -->
        <div class="section">
            <div class="section-title">ü§ñ Overtime & Work Description Generator</div>
            
            <div class="generator-controls">
                <div class="subsection-title">Method 1: Generate from Planner Trips</div>
                <div class="alert alert-info" style="margin-top: 12px;">
                    This will use the allocated trips from the "Project Sites" section above. Add keywords to each site for more specific descriptions.
                </div>
                <button id="generateDescBtn" class="btn btn-primary">‚ú® Generate from Planner</button>

                <div class="subsection-title">Method 2: Process External OT File</div>
                 <div class="alert alert-info" style="margin-top: 12px;">
                    Upload a JSON file from your other OT Generator app to process its entries.
                </div>
                <div class="form-group">
                    <label>Upload Overtime JSON File</label>
                    <input type="file" id="jsonFileInput" accept=".json" class="form-control">
                </div>
                <button id="processJsonFileBtn" class="btn btn-success">PROCESS UPLOADED JSON</button>
            </div>
            
            <hr style="margin: 32px 0; border: none; border-top: 1px solid var(--border-color);">
            
            <div class="section-title" id="generated-results-anchor">Generated Results</div>
            
            <div class="btn-group" style="margin-top: 0; margin-bottom: 16px;">
                 <button id="exportJsonBtn" class="btn btn-secondary">üíæ Export Planner Config (JSON)</button>
            </div>

            <div id="plannerResultsContainer">
                <div class="subsection-title">Results from Planner</div>
                <div class="btn-group" style="margin-top:0; margin-bottom: 15px;">
                    <button id="exportPlannerCsvBtn" class="btn btn-secondary">üìÑ Export Planner Results to CSV</button>
                </div>
                <div id="plannerGeneratorResults">
                    <p>Planner-generated descriptions will appear here.</p>
                </div>
            </div>

            <div id="jsonResultsContainer" style="margin-top: 24px;">
                <div class="subsection-title">Results from Uploaded OT File</div>
                 <div class="btn-group" style="margin-top:0; margin-bottom: 15px;">
                    <button id="exportFileCsvBtn" class="btn btn-secondary">üìÑ Export OT File Results to CSV</button>
                </div>
                <div id="jsonGeneratorResults">
                    <p>Uploaded file descriptions will appear here.</p>
                </div>
            </div>
        </div>

    </div>
    
    <script type="module">
        import flatpickr from "https://cdn.jsdelivr.net/npm/flatpickr/+esm";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfq5zOyd0nJQ61durfVvvNals789n4-WE",
            authDomain: "mileage-planner.firebaseapp.com",
            databaseURL: "https://mileage-planner-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mileage-planner",
            storageBucket: "mileage-planner.appspot.com",
            messagingSenderId: "924534923921",
            appId: "1:924534923921:web:866e5cbbd3ae5b04175530",
            measurementId: "G-6547J3HQ67"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        let directionsService, autocompleteService, placesService;
        let sites = [];
        let config = {
            startPoint: '',
            startPointCoords: null,
            mileageRate: 0.80,
            targetAmount: 0,
            dateRange: { start: null, end: null },
            includeSaturday: false,
            includeSunday: false
        };
        let apiKey = '';
        let apiValidated = false;
        
        let plannerGeneratedData = [];
        let fileGeneratedData = [];

        function toFirestore(data) {
            const firestoreData = { ...data };
            if (firestoreData.dateRange) {
                firestoreData.dateRange.start = firestoreData.dateRange.start ? firestoreData.dateRange.start.toISOString() : null;
                firestoreData.dateRange.end = firestoreData.dateRange.end ? firestoreData.dateRange.end.toISOString() : null;
            }
            if (firestoreData.allocation) {
                firestoreData.allocation = firestoreData.allocation.map(a => ({ ...a, date: a.date.toISOString() }));
            }
            return firestoreData;
        }

        function fromFirestore(data) {
            const localData = { ...data };
            if (localData.dateRange) {
                localData.dateRange.start = localData.dateRange.start ? new Date(localData.dateRange.start) : null;
                localData.dateRange.end = localData.dateRange.end ? new Date(localData.dateRange.end) : null;
            }
             if (localData.allocation) {
                localData.allocation = localData.allocation.map(a => ({ ...a, date: new Date(a.date) }));
            }
            return localData;
        }

        async function saveConfig() {
            config.mileageRate = parseFloat(document.getElementById('mileageRate').value) || 0;
            config.targetAmount = parseFloat(document.getElementById('targetAmount').value) || 0;
            config.includeSaturday = document.getElementById('includeSaturday').checked;
            config.includeSunday = document.getElementById('includeSunday').checked;
            
            try { await setDoc(doc(db, 'plannerData', 'config'), toFirestore(config)); } 
            catch(e) { console.error("Error saving config:", e); }
            
            renderSites();
            updateSummary();
        }

        async function saveSite(site) {
             try { await setDoc(doc(db, 'sites', site.id.toString()), toFirestore(site)); } 
             catch(e) { console.error("Error saving site:", e); }
        }

        async function savePlannerResults(data) {
            try {
                const dataToSave = data.map(d => ({...d, date: d.date.toISOString()}));
                await setDoc(doc(db, 'generatedResults', 'planner'), { results: dataToSave });
            } catch (e) {
                console.error("Error saving planner results:", e);
            }
        }

        async function saveFileResults(data) {
            try {
                const dataToSave = data.map(d => ({...d, date: d.date.toISOString()}));
                await setDoc(doc(db, 'generatedResults', 'file'), { results: dataToSave });
            } catch (e) {
                console.error("Error saving file results:", e);
            }
        }

        async function loadData() {
            try {
                const configSnap = await getDoc(doc(db, 'plannerData', 'config'));
                if (configSnap.exists()) {
                    config = fromFirestore(configSnap.data());
                    document.getElementById('startPoint').value = config.startPoint || '';
                    document.getElementById('mileageRate').value = config.mileageRate;
                    document.getElementById('targetAmount').value = config.targetAmount;
                    document.getElementById('includeSaturday').checked = config.includeSaturday;
                    document.getElementById('includeSunday').checked = config.includeSunday;
                    if (config.dateRange.start && config.dateRange.end) {
                        document.getElementById('dateRange')._flatpickr.setDate([config.dateRange.start, config.dateRange.end]);
                    }
                }
                const sitesSnap = await getDocs(collection(db, 'sites'));
                sites = sitesSnap.docs.map(d => fromFirestore(d.data()));
                renderSites();
                updateSummary();

                const plannerResultsSnap = await getDoc(doc(db, 'generatedResults', 'planner'));
                if (plannerResultsSnap.exists()) {
                    plannerGeneratedData = plannerResultsSnap.data().results.map(d => ({...d, date: new Date(d.date)}));
                    displayPlannerResults(plannerGeneratedData);
                }

                const fileResultsSnap = await getDoc(doc(db, 'generatedResults', 'file'));
                if (fileResultsSnap.exists()) {
                    fileGeneratedData = fileResultsSnap.data().results.map(d => ({...d, date: new Date(d.date)}));
                    displayUploadedFileResults(fileGeneratedData);
                }

            } catch(e) { console.error("Error loading data:", e); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            initializeFlatpickr();
            setupEventListeners();
            checkForAPIKey(); 
        });

        function setupEventListeners() {
            document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);
            document.getElementById('validateApiKeyBtn').addEventListener('click', validateAndSaveAPIKey);
            document.getElementById('apiKeyHelpBtn').addEventListener('click', showAPIKeyHelp);
            document.getElementById('useGpsBtn').addEventListener('click', useCurrentLocation);
            document.getElementById('addSiteBtn').addEventListener('click', addSite);
            document.getElementById('autoAllocateBtn').addEventListener('click', autoAllocate);
            document.getElementById('clearAllocationBtn').addEventListener('click', clearAllocation);
            document.getElementById('startPoint').addEventListener('input', handleStartPointInput);
            document.getElementById('siteAddress').addEventListener('input', handleSiteAddressInput);
            document.getElementById('mileageRate').addEventListener('change', saveConfig);
            document.getElementById('targetAmount').addEventListener('change', saveConfig);
            document.getElementById('includeSaturday').addEventListener('change', saveConfig);
            document.getElementById('includeSunday').addEventListener('change', saveConfig);
            document.getElementById('mileageRate').addEventListener('input', updateSummary);
            document.getElementById('targetAmount').addEventListener('input', updateSummary);
            document.getElementById('exportJsonBtn').addEventListener('click', exportToJson);
            document.getElementById('generateDescBtn').addEventListener('click', generateAllDescriptionsFromPlanner);
            document.getElementById('processJsonFileBtn').addEventListener('click', processUploadedJsonFile);
            document.getElementById('meetTargetBtn').addEventListener('click', meetTarget);
            document.getElementById('exportPlannerCsvBtn').addEventListener('click', exportPlannerResultsToCsv);
            document.getElementById('exportFileCsvBtn').addEventListener('click', exportFileResultsToCsv);

            const sitesList = document.getElementById('sitesList');
            sitesList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('remove-site-btn')) {
                    await removeSite(parseInt(e.target.dataset.siteId));
                }
            });

            sitesList.addEventListener('change', async (e) => {
                 if (e.target.classList.contains('trip-input')) {
                    await updateTrips(parseInt(e.target.dataset.siteId), e.target.dataset.dateStr, e.target.value);
                }
                if (e.target.classList.contains('single-trip-toggle')) {
                    await toggleSiteSingleTripStatus(parseInt(e.target.dataset.siteId), e.target.checked);
                }
            });
            
            sitesList.addEventListener('input', async (e) => {
                if (e.target.classList.contains('site-keywords-input')) {
                    const siteId = parseInt(e.target.dataset.siteId);
                    const site = sites.find(s => s.id === siteId);
                    if (site) {
                        site.keywords = e.target.value.trim();
                        await saveSite(site);
                    }
                }
            });
        }
        
        async function toggleSiteSingleTripStatus(siteId, isSingleTrip) {
            const site = sites.find(s => s.id === siteId);
            if (!site) return;
            site.isSingleTrip = isSingleTrip;
            await saveSite(site);
            renderSites();
        }
        
        function toggleTheme() {
            const html = document.documentElement;
            const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function loadTheme() {
            document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');
        }

        function checkForAPIKey() {
            const savedKey = localStorage.getItem('googleMapsApiKey');
            if (savedKey) {
                apiKey = savedKey;
                document.getElementById('apiKeyInput').style.display = 'none';
                document.getElementById('apiMessage').style.display = 'block';
                loadGoogleMapsAPI();
            }
        }

        function validateAndSaveAPIKey() {
            const keyInput = document.getElementById('apiKeyField').value.trim();
            if (!keyInput) { alert('Please enter an API key'); return; }
            apiKey = keyInput;
            localStorage.setItem('googleMapsApiKey', apiKey);
            document.getElementById('apiKeyInput').style.display = 'none';
            document.getElementById('apiMessage').style.display = 'block';
            loadGoogleMapsAPI();
        }

        function showAPIKeyHelp() {
            alert(`How to get Google Maps API Key...`);
        }

        function loadGoogleMapsAPI() {
            if (window.google) return;
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places,geometry&callback=initMap`;
            script.async = true;
            script.defer = true;
            script.onerror = () => updateAPIStatus(false, 'Failed to load Google Maps API.');
            window.initMap = initMap;
            document.head.appendChild(script);
        }
        
        async function initMap() {
            try {
                directionsService = new google.maps.DirectionsService();
                autocompleteService = new google.maps.places.AutocompleteService();
                placesService = new google.maps.places.PlacesService(document.createElement('div'));
                apiValidated = true;
                updateAPIStatus(true, 'Google Maps API validated!');
                await loadData();
            } catch (error) {
                apiValidated = false;
                updateAPIStatus(false, `API validation failed: ${error.message}`);
            }
        }

        function updateAPIStatus(success, message) {
            const badge = document.getElementById('apiStatusBadge');
            const messageEl = document.getElementById('apiMessage');
            badge.className = success ? 'status-badge status-success' : 'status-badge status-error';
            badge.textContent = success ? 'Connected' : 'Error';
            messageEl.className = success ? 'alert alert-info' : 'alert alert-danger';
            messageEl.textContent = message;
        }

        function initializeFlatpickr() {
            document.getElementById('dateRange')._flatpickr = flatpickr("#dateRange", {
                mode: 'range',
                dateFormat: 'Y-m-d',
                onChange: (selectedDates) => {
                    if (selectedDates.length === 2) {
                        config.dateRange.start = selectedDates[0];
                        config.dateRange.end = selectedDates[1];
                        saveConfig();
                    }
                },
            });
        }
        
        function handleStartPointInput(e) {
            if (e.target.value.length < 3 || !apiValidated) return;
            autocompleteService.getPlacePredictions({ input: e.target.value }, (p, s) => {
                if (s === 'OK') showAutocomplete('startPointDropdown', p, selectStartPoint);
            });
        }

        function handleSiteAddressInput(e) {
            if (e.target.value.length < 3 || !apiValidated) return;
            autocompleteService.getPlacePredictions({ input: e.target.value }, (p, s) => {
                if (s === 'OK') showAutocomplete('siteAddressDropdown', p, selectSiteAddress);
            });
        }

        function showAutocomplete(dropdownId, predictions, callback) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.innerHTML = '';
            dropdown.style.display = 'block';
            predictions.forEach(p => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = p.description;
                item.onclick = () => callback(p);
                dropdown.appendChild(item);
            });
            document.addEventListener('click', e => {
                if (!dropdown.contains(e.target)) dropdown.style.display = 'none';
            }, { once: true });
        }

        function selectStartPoint(prediction) {
            document.getElementById('startPoint').value = prediction.description;
            document.getElementById('startPointDropdown').style.display = 'none';
            placesService.getDetails({ placeId: prediction.place_id }, (place, status) => {
                if (status === 'OK') {
                    config.startPoint = prediction.description;
                    config.startPointCoords = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
                    saveConfig();
                    recalculateAllDistances();
                }
            });
        }

        function selectSiteAddress(prediction) {
            document.getElementById('siteAddress').value = prediction.description;
            document.getElementById('siteAddressDropdown').style.display = 'none';
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) return alert('Geolocation not supported.');
            navigator.geolocation.getCurrentPosition(pos => {
                const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                (new google.maps.Geocoder()).geocode({ location: coords }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        document.getElementById('startPoint').value = results[0].formatted_address;
                        config.startPoint = results[0].formatted_address;
                        config.startPointCoords = coords;
                        saveConfig();
                        recalculateAllDistances();
                    }
                });
            }, err => alert(`Geolocation error: ${err.message}`));
        }

        async function addSite() {
            if (!apiValidated) return alert('API not validated.');
            const name = document.getElementById('siteName').value.trim();
            const address = document.getElementById('siteAddress').value.trim();
            const isSingleTrip = document.getElementById('isSingleTripCheckbox').checked;
            const keywords = document.getElementById('siteKeywords').value.trim();
            const site = { id: Date.now(), name, address, distance: 0, allocation: [], isSingleTrip, isAdjusted: false, keywords: keywords };
            sites.push(site);
            document.getElementById('siteName').value = '';
            document.getElementById('siteAddress').value = '';
            document.getElementById('siteKeywords').value = '';
            document.getElementById('isSingleTripCheckbox').checked = false;
            renderSites();
            await calculateDistance(site);
        }

        function calculateDistance(site) {
             return new Promise((resolve, reject) => {
                if (!config.startPointCoords) return reject(new Error('Start point not set.'));
                site.isAdjusted = false;
                placesService.findPlaceFromQuery({ query: site.address, fields: ['geometry'] }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        directionsService.route({
                            origin: config.startPointCoords,
                            destination: results[0].geometry.location,
                            travelMode: google.maps.TravelMode.DRIVING
                        }, async (result, status) => {
                            if (status === 'OK') {
                                site.distance = Math.round((result.routes[0].legs[0].distance.value / 1000) * 2 * 100) / 100;
                                await saveSite(site);
                                renderSites();
                                updateSummary();
                                resolve();
                            } else { reject(new Error('Directions service failed.')); }
                        });
                    } else { reject(new Error('Place not found.')); }
                });
            });
        }

        async function recalculateAllDistances() {
            for (const site of sites) await calculateDistance(site);
        }

        async function removeSite(siteId) {
            if (confirm('Are you sure you want to remove this site?')) {
                sites = sites.filter(s => s.id !== siteId);
                await deleteDoc(doc(db, 'sites', String(siteId)));
                renderSites();
                updateSummary();
            }
        }

        function getDaysInRange() {
            if (!config.dateRange.start || !config.dateRange.end) return [];
            const days = [];
            let current = new Date(config.dateRange.start);
            const end = new Date(config.dateRange.end);
            while (current <= end) {
                const dayOfWeek = current.getDay();
                if ((dayOfWeek !== 0 && dayOfWeek !== 6) || (dayOfWeek === 6 && config.includeSaturday) || (dayOfWeek === 0 && config.includeSunday)) {
                    days.push(new Date(current));
                }
                current.setDate(current.getDate() + 1);
            }
            return days;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function autoAllocate() {
            if (sites.length === 0) return alert('Please add at least one site.');
            if (!config.dateRange.start) return alert('Please select a date range.');
            const target = parseFloat(document.getElementById('targetAmount').value) || 0;
            const rate = parseFloat(document.getElementById('mileageRate').value) || 0;
            if (target <= 0) return alert('Please set a target amount > 0.');
            let days = getDaysInRange();
            if (days.length === 0) return alert('No available days in range.');
            
            shuffleArray(days);

            sites.forEach(site => {
                site.allocation = [];
                if (site.isAdjusted) { recalculateAllDistances(); return; }
            });
            let currentAmount = 0;
            const maxTripsPerDay = 3;

            const allSitesSorted = [...sites].sort((a, b) => b.distance - a.distance);

            const dayUsage = new Map();
            days.forEach(day => dayUsage.set(day.getTime(), 0));
            let dayCursor = 0;

            for (const site of allSitesSorted) {
                if (currentAmount >= target) break;

                let allocated = false;
                for (let i = 0; i < days.length; i++) {
                    const day = days[(dayCursor + i) % days.length];
                    const dayTs = day.getTime();
                    const isLongTrip = site.distance > 100;
                    
                    const canAllocate = isLongTrip ? (dayUsage.get(dayTs) === 0) : (dayUsage.get(dayTs) < maxTripsPerDay);

                    if (canAllocate) {
                        site.allocation.push({ date: day, trips: 1 });
                        dayUsage.set(dayTs, dayUsage.get(dayTs) + (isLongTrip ? maxTripsPerDay : 1));
                        currentAmount += site.distance * rate;
                        dayCursor = (dayCursor + i + 1) % days.length;
                        allocated = true;
                        break;
                    }
                }
            }

            if (currentAmount < target) {
                let tripCounter = 0;
                const safetyLimit = days.length * allSitesSorted.length * maxTripsPerDay;
                while (currentAmount < target && tripCounter < safetyLimit) {
                    const site = allSitesSorted[tripCounter % allSitesSorted.length];
                    const day = days[Math.floor(tripCounter / allSitesSorted.length) % days.length];
                    const dayTs = day.getTime();
                    tripCounter++;
                    
                    const totalTripsForSite = site.allocation.reduce((sum, a) => sum + a.trips, 0);
                    if ((site.isSingleTrip && totalTripsForSite >= 1) || dayUsage.get(dayTs) >= maxTripsPerDay || site.distance > 100) {
                        continue;
                    }

                    let dayAlloc = site.allocation.find(a => a.date.getTime() === dayTs);
                    if (!dayAlloc) {
                        dayAlloc = { date: day, trips: 0 };
                        site.allocation.push(dayAlloc);
                    }
                    dayAlloc.trips++;
                    dayUsage.set(dayTs, dayUsage.get(dayTs) + 1);
                    currentAmount += site.distance * rate;
                }
            }
            
            const batch = writeBatch(db);
            sites.forEach(site => batch.set(doc(db, 'sites', String(site.id)), toFirestore(site)));
            await batch.commit();
            
            const allocateBtn = document.getElementById('autoAllocateBtn');
            allocateBtn.innerHTML = 'üîÄ Relocate';
            allocateBtn.classList.remove('btn-success');
            allocateBtn.classList.add('btn-secondary');

            if (currentAmount < target) {
                showAllocationAlert('warning', `Target not fully met. Shortfall: RM ${(target - currentAmount).toFixed(2)}.`);
            } else {
                showAllocationAlert('info', `Allocation complete! Total: RM ${currentAmount.toFixed(2)}.`);
            }
            renderSites();
            updateSummary();
        }

        async function clearAllocation() {
            if (confirm('Clear all trip allocations? This will also reset any adjusted distances.')) {
                const sitesToRecalculate = sites.filter(s => s.isAdjusted);
                sites.forEach(site => {
                    site.allocation = [];
                    site.isAdjusted = false; 
                });
                
                const batch = writeBatch(db);
                sites.forEach(site => batch.set(doc(db, 'sites', String(site.id)), toFirestore(site)));
                await batch.commit();

                for (const site of sitesToRecalculate) {
                    await calculateDistance(site);
                }
                
                const allocateBtn = document.getElementById('autoAllocateBtn');
                allocateBtn.innerHTML = '‚ú® Auto Allocate';
                allocateBtn.classList.remove('btn-secondary');
                allocateBtn.classList.add('btn-success');
                
                document.getElementById('allocationAlert').style.display = 'none';
                plannerGeneratedData = [];
                fileGeneratedData = [];
                await savePlannerResults([]);
                await saveFileResults([]);
                document.getElementById('plannerGeneratorResults').innerHTML = '<p>Planner-generated descriptions will appear here.</p>';
                document.getElementById('jsonGeneratorResults').innerHTML = '<p>Uploaded file descriptions will appear here.</p>';

                renderSites();
                updateSummary();
            }
        }

        async function updateTrips(siteId, dateStr, trips) {
            const site = sites.find(s => s.id === siteId);
            if (!site) return;
            const date = new Date(dateStr);
            const numTrips = Math.max(0, parseInt(trips) || 0);

            let dayAlloc = site.allocation.find(a => a.date.getTime() === date.getTime());
            if (numTrips > 0) {
                 if (!dayAlloc) site.allocation.push({ date, trips: numTrips });
                 else dayAlloc.trips = numTrips;
            } else {
                site.allocation = site.allocation.filter(a => a.date.getTime() !== date.getTime());
            }
            await saveSite(site);
            renderSites();
            updateSummary();
        }

        function showAllocationAlert(type, message) {
            const alertDiv = document.getElementById('allocationAlert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
        }

        function getClaimEntriesFromPlanner() {
            const entries = [];
            sites.forEach(site => {
                site.allocation.forEach(alloc => {
                    if (alloc.trips > 0) {
                        for (let i = 0; i < alloc.trips; i++) {
                             entries.push({
                                date: alloc.date,
                                siteName: site.name,
                                siteAddress: site.address,
                                keywords: site.keywords,
                                distance: site.distance,
                                isAdjusted: site.isAdjusted
                            });
                        }
                    }
                });
            });
            entries.sort((a, b) => a.date - b.date);
            return entries;
        }
        
        // --- DESCRIPTION GENERATOR LOGIC ---

        function generateDescriptionFromPlanner(siteName, keywords) {
            const lexicon = {
                'default': {
                    actionVerbs: ['Sorted out', 'Fixed up', 'Ran a check on', 'Reconfigured', 'Tinkered with'],
                    itObjects: ['the main switch', 'a router', 'the office firewall', 'a Wi-Fi point', 'the server rack', 'a user\'s PC', 'the phone system'],
                    purposes: ['get everyone back online', 'speed things up a bit', 'resolve a user ticket', 'patch a security hole'],
                    diagnoses: ['a misconfigured VLAN', 'a faulty power supply', 'outdated firmware', 'a DNS issue', 'a loose cable']
                },
                'kaseya': {
                    actionVerbs: ['Pushed the VSA agent to', 'Fixed a broken script on', 'Updated a script for', 'Pulled a report from', 'Ran patches on'],
                    itObjects: ['the servers', 'a bunch of PCs', 'the domain controller', 'the critical gear', 'the remote management tool'],
                    purposes: ['ensure all agents were installed', 'automate a maintenance job', 'complete the monthly patch cycle', 'clear a security warning'],
                    diagnoses: ['an agent login issue', 'a typo in the script', 'a new security policy requirement', 'an alert from the monitoring system']
                },
                'network': {
                    actionVerbs: ['Updated the firmware on', 'Swapped out a faulty', 'Tidied up the cabling for', 'Changed the VLANs on', 'Installed a new'],
                    itObjects: ['the core switch', 'an edge router', 'a Wi-Fi AP', 'a patch panel port', 'a fiber transceiver', 'the branch firewall'],
                    purposes: ['handle more traffic', 'fix a dropping connection', 'separate guest and staff Wi-Fi', 'link up with another office'],
                    diagnoses: ['a broadcast storm', 'high latency on the link', 'a mismatch with the network diagram', 'the DHCP server running out of IPs']
                },
                'server': {
                    actionVerbs: ['Ran Windows updates on', 'Replaced a failed hard drive in', 'Moved a VM to', 'Checked resource usage on', 'Performed a quick security audit on'],
                    itObjects: ['the domain controller', 'the file server', 'a different VMware host', 'the database server', 'the physical server'],
                    purposes: ['perform scheduled server maintenance', 'prevent data loss', 'better balance the load', 'figure out why it was running slow'],
                    diagnoses: ['errors in the system event logs', 'a predictive drive failure alert', 'preparation for retiring old hardware', 'the CPU hitting 100%']
                },
                'siem': {
                    actionVerbs: ['Developed API endpoints for', 'Investigated a performance bottleneck in', 'Deployed updates to', 'Refactored the'],
                    itObjects: ['the new two-factor authentication module', 'the API gateway', 'the reporting engine', 'the authentication service'],
                    purposes: ['enhance system security', 'improve overall performance', 'release a new feature', 'address a critical bug'],
                    diagnoses: ['an inefficient database query', 'a memory leak in the service', 'a misconfiguration in the deployment script', 'an issue with a third-party dependency']
                }
            };

            const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
            
            const lowerKeywords = (keywords || '').toLowerCase();
            let selectedCategory = 'default';

            for (const key in lexicon) {
                if (key !== 'default' && lowerKeywords.includes(key)) {
                    selectedCategory = key;
                    break;
                }
            }

            const vocab = lexicon[selectedCategory];
            const action = getRandomItem(vocab.actionVerbs);
            const obj = getRandomItem(vocab.itObjects);
            const purpose = getRandomItem(vocab.purposes);
            const diagnosis = getRandomItem(vocab.diagnoses);

            const templates = [
                () => `${action} ${obj} at ${siteName} to ${purpose}. The problem was traced back to ${diagnosis}.`,
                () => `At ${siteName}, worked on the ${obj} in order to ${purpose}. Found that the issue was caused by ${diagnosis}.`,
                () => `A site visit to ${siteName} was needed to address an issue with ${obj}. The cause was simply ${diagnosis}, and the fix was implemented to ${purpose}.`,
                () => `To ${purpose}, ${action.toLowerCase()} ${obj} at ${siteName}. It was discovered that ${diagnosis} was the culprit.`,
                () => `Visited ${siteName} to handle a problem with ${obj}. It was a case of ${diagnosis}, and the work was completed so we could ${purpose}.`
            ];

            const selectedTemplate = getRandomItem(templates);
            return selectedTemplate();
        }

        function generateDescriptionFromRemark(originalRemark) {
            const lexicon = {
                'default': {
                    actionVerbs: ['Sorted out', 'Fixed up', 'Ran a check on', 'Reconfigured', 'Tinkered with'],
                    itObjects: ['the main switch', 'a router', 'the office firewall', 'a Wi-Fi point', 'the server rack', 'a user\'s PC', 'the phone system'],
                    purposes: ['get everyone back online', 'speed things up a bit', 'resolve a user ticket', 'patch a security hole'],
                    diagnoses: ['a misconfigured VLAN', 'a faulty power supply', 'outdated firmware', 'a DNS issue', 'a loose cable']
                },
                'kaseya': {
                    actionVerbs: ['Pushed the VSA agent to', 'Fixed a broken script on', 'Updated a script for', 'Pulled a report from', 'Ran patches on'],
                    itObjects: ['the servers', 'a bunch of PCs', 'the domain controller', 'the critical gear', 'the remote management tool'],
                    purposes: ['ensure all agents were installed', 'automate a maintenance job', 'complete the monthly patch cycle', 'clear a security warning'],
                    diagnoses: ['an agent login issue', 'a typo in the script', 'a new security policy requirement', 'an alert from the monitoring system']
                },
                'network': {
                    actionVerbs: ['Updated the firmware on', 'Swapped out a faulty', 'Tidied up the cabling for', 'Changed the VLANs on', 'Installed a new'],
                    itObjects: ['the core switch', 'an edge router', 'a Wi-Fi AP', 'a patch panel port', 'a fiber transceiver', 'the branch firewall'],
                    purposes: ['handle more traffic', 'fix a dropping connection', 'separate guest and staff Wi-Fi', 'link up with another office'],
                    diagnoses: ['a broadcast storm', 'high latency on the link', 'a mismatch with the network diagram', 'the DHCP server running out of IPs']
                },
                'server': {
                    actionVerbs: ['Ran Windows updates on', 'Replaced a failed hard drive in', 'Moved a VM to', 'Checked resource usage on', 'Performed a quick security audit on'],
                    itObjects: ['the domain controller', 'the file server', 'a different VMware host', 'the database server', 'the physical server'],
                    purposes: ['perform scheduled server maintenance', 'prevent data loss', 'better balance the load', 'figure out why it was running slow'],
                    diagnoses: ['errors in the system event logs', 'a predictive drive failure alert', 'preparation for retiring old hardware', 'the CPU hitting 100%']
                },
                'siem': {
                    actionVerbs: ['Developed API endpoints for', 'Investigated a performance bottleneck in', 'Deployed updates to', 'Refactored the'],
                    itObjects: ['the new two-factor authentication module', 'the API gateway', 'the reporting engine', 'the authentication service'],
                    purposes: ['enhance system security', 'improve overall performance', 'release a new feature', 'address a critical bug'],
                    diagnoses: ['an inefficient database query', 'a memory leak in the service', 'a misconfiguration in the deployment script', 'an issue with a third-party dependency']
                }
            };

            const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
            
            const parts = originalRemark.split(' - ');
            const siteName = parts[0] || 'the site';
            const keywords = originalRemark.toLowerCase();

            let selectedCategory = 'default';
            for (const key in lexicon) {
                if (key !== 'default' && keywords.includes(key)) {
                    selectedCategory = key;
                    break;
                }
            }

            const vocab = lexicon[selectedCategory];
            const action = getRandomItem(vocab.actionVerbs);
            const obj = getRandomItem(vocab.itObjects);
            const purpose = getRandomItem(vocab.purposes);
            const diagnosis = getRandomItem(vocab.diagnoses);

            const templates = [
                () => `${action} ${obj} at ${siteName} to ${purpose}. The problem was traced back to ${diagnosis}.`,
                () => `At ${siteName}, worked on ${obj} in order to ${purpose}. Found that the issue was caused by ${diagnosis}.`,
                () => `A visit to ${siteName} was needed to address an issue with ${obj}. The cause was simply ${diagnosis}, and the fix was implemented to ${purpose}.`,
                () => `To ${purpose}, ${action.toLowerCase()} ${obj} at ${siteName}. It was discovered that ${diagnosis} was the culprit.`,
                () => `Worked on a problem with ${obj} at ${siteName}. It was a case of ${diagnosis}, and the work was completed so we could ${purpose}.`
            ];

            const selectedTemplate = getRandomItem(templates);
            return selectedTemplate();
        }

        function generateAllDescriptionsFromPlanner() {
            const claimEntries = getClaimEntriesFromPlanner();
            if (claimEntries.length === 0) {
                alert('No allocated trips found. Please allocate trips before generating descriptions.');
                return;
            }
            
            plannerGeneratedData = claimEntries.map(entry => ({
                ...entry,
                workDescription: generateDescriptionFromPlanner(entry.siteName, entry.keywords)
            }));
            
            savePlannerResults(plannerGeneratedData);
            displayPlannerResults(plannerGeneratedData);
            showAllocationAlert('success', `Successfully generated ${plannerGeneratedData.length} unique work descriptions from the planner!`);
            document.getElementById('generated-results-anchor').scrollIntoView({ behavior: 'smooth' });
        }

        function processUploadedJsonFile() {
            const fileInput = document.getElementById('jsonFileInput');
            if (fileInput.files.length === 0) {
                alert('Please select a JSON file first.');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (event) => {
                try {
                    const entries = JSON.parse(event.target.result);
                    
                    let processedData = entries.map(entry => ({
                        date: new Date(entry.date),
                        originalRemark: entry.remarks,
                        workDescription: generateDescriptionFromRemark(entry.remarks)
                    }));

                    processedData.sort((a, b) => a.date - b.date);
                    
                    fileGeneratedData = processedData;
                    await saveFileResults(fileGeneratedData);
                    displayUploadedFileResults(fileGeneratedData);
                    showAllocationAlert('success', `Successfully processed ${fileGeneratedData.length} entries from the uploaded file!`);
                    document.getElementById('generated-results-anchor').scrollIntoView({ behavior: 'smooth' });

                } catch (e) {
                    alert('Error parsing JSON file. Please ensure it is valid.');
                    console.error(e);
                }
            };
            reader.readAsText(file);
        }

        function displayPlannerResults(data) {
            const container = document.getElementById('plannerGeneratorResults');
            if (!data || data.length === 0) {
                container.innerHTML = '<p>No descriptions generated.</p>';
                return;
            }
            let html = `
                <table class="claim-table">
                    <thead><tr><th>Date</th><th>Site Name</th><th>Generated Work Description</th></tr></thead>
                    <tbody>`;
            data.forEach(entry => {
                const dateObj = entry.date instanceof Date ? entry.date : new Date(entry.date);
                const formattedDate = !isNaN(dateObj) ? dateObj.toLocaleDateString() : 'Invalid Date';
                html += `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${entry.siteName}</td>
                        <td>${entry.workDescription}</td>
                    </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function displayUploadedFileResults(data) {
            const container = document.getElementById('jsonGeneratorResults');
            if (!data || data.length === 0) {
                container.innerHTML = '<p>No descriptions generated.</p>';
                return;
            }
            let html = `
                <table class="claim-table">
                     <thead><tr><th>Date</th><th>Original Remark</th><th>Generated Remark</th></tr></thead>
                    <tbody>`;
            data.forEach(entry => {
                const dateObj = entry.date instanceof Date ? entry.date : new Date(entry.date);
                const formattedDate = !isNaN(dateObj) ? dateObj.toLocaleDateString() : 'Invalid Date';

                html += `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${entry.originalRemark}</td>
                        <td>${entry.workDescription}</td>
                    </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function exportPlannerResultsToCsv() {
            if (plannerGeneratedData.length === 0) {
                alert('No planner results to export. Please generate them first.');
                return;
            }
            
            const mileageRate = parseFloat(document.getElementById('mileageRate').value) || 0;
            const headers = [ 'Date', 'Site Name', 'Site Address', 'Round-trip Distance (km)', 'Amount (RM)', 'Work Description' ];
            const csvRows = plannerGeneratedData.map(entry => {
                const row = [ 
                    entry.date.toLocaleDateString(), 
                    entry.isAdjusted ? `${entry.siteName} (Adjusted)` : entry.siteName,
                    entry.siteAddress, 
                    (entry.distance || 0).toFixed(2),
                    ((entry.distance || 0) * mileageRate).toFixed(2),
                    entry.workDescription 
                ];
                return row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',');
            });

            const csvContent = [headers.join(','), ...csvRows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `planner-results-${today}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportFileResultsToCsv() {
            if (fileGeneratedData.length === 0) {
                alert('No OT file results to export. Please process a file first.');
                return;
            }
            
            const headers = [ 'Date', 'Original Remark', 'Generated Remark' ];
            const csvRows = fileGeneratedData.map(entry => {
                const row = [ 
                    entry.date.toLocaleDateString(),
                    entry.originalRemark,
                    entry.workDescription
                ];
                return row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',');
            });

            const csvContent = [headers.join(','), ...csvRows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `ot-file-results-${today}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToJson() {
            if (sites.length === 0 && !config.startPoint) {
                alert("No planner data to export.");
                return;
            }
            const dataToExport = {
                config: toFirestore(config),
                sites: sites.map(site => toFirestore(site))
            };

            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `mileage-planner-data-${today}.json`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function meetTarget() {
            const targetAmount = parseFloat(document.getElementById('targetAmount').value) || 0;
            const rate = parseFloat(document.getElementById('mileageRate').value) || 0;
            if (rate === 0) return alert("Mileage rate cannot be zero.");

            const currentAmount = sites.reduce((sum, site) => 
                sum + site.allocation.reduce((siteSum, alloc) => siteSum + (site.distance * alloc.trips), 0), 0) * rate;

            const shortfallAmount = targetAmount - currentAmount;
            if (shortfallAmount <= 0) return alert("Target already met or exceeded.");
            
            const shortfallDistance = shortfallAmount / rate;

            const candidateSites = sites.filter(site => 
                !site.isSingleTrip && 
                site.distance <= 100 &&
                site.allocation.reduce((sum, a) => sum + a.trips, 0) > 0
            );

            if (candidateSites.length === 0) {
                return alert("Optimization failed: No suitable sites found for adjustment (must be a non-single, short-distance site with at least one trip).");
            }
            
            const totalTripsAcrossCandidates = candidateSites.reduce((sum, site) => 
                sum + site.allocation.reduce((siteSum, alloc) => siteSum + alloc.trips, 0), 0
            );

            if (totalTripsAcrossCandidates === 0) {
                 return alert("Optimization failed: No trips allocated to suitable sites.");
            }

            const distanceToAddPerTrip = shortfallDistance / totalTripsAcrossCandidates;

            const batch = writeBatch(db);
            candidateSites.forEach(site => {
                site.distance += distanceToAddPerTrip; 
                site.isAdjusted = true;
                batch.set(doc(db, 'sites', String(site.id)), toFirestore(site));
            });

            await batch.commit();
            
            renderSites();
            updateSummary();
            showAllocationAlert('success', `Target met! Distances for ${candidateSites.length} eligible sites have been fairly adjusted.`);
        }

        function renderSites() {
            const container = document.getElementById('sitesList');
            if (sites.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No sites added yet.</div>';
                return;
            }
            const days = getDaysInRange();
            container.innerHTML = sites.sort((a,b) => a.name.localeCompare(b.name)).map(site => {
                const totalAllocatedTrips = site.allocation.reduce((acc, a) => acc + a.trips, 0);
                const displayName = site.isAdjusted ? `${site.name} <span class="status-badge status-warning">Adjusted</span>` : site.name;
                return `
                <div class="site-card">
                    <div class="site-header">
                        <div class="site-info">
                            <div class="site-name">${displayName}</div>
                            <div class="site-address">${site.address}</div>
                            <div class="site-distance">${site.distance > 0 ? `${site.distance.toFixed(2)} km (round-trip)` : '<span class="loading"></span>'}</div>
                            <div class="form-group" style="margin-top: 10px; margin-bottom: 5px;">
                                <label class="checkbox-label">
                                    <input type="checkbox" class="single-trip-toggle" data-site-id="${site.id}" ${site.isSingleTrip ? 'checked' : ''}>
                                    <span>Single Trip Only</span>
                                </label>
                            </div>
                             <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
                                <label style="font-size: 12px; margin-bottom: 4px;">Project Keywords:</label>
                                <input type="text" class="site-keywords-input" placeholder="e.g., Kaseya, network, server" value="${site.keywords || ''}" data-site-id="${site.id}">
                            </div>
                        </div>
                        <button class="remove-site-btn" data-site-id="${site.id}">‚úï</button>
                    </div>
                    ${days.length > 0 ? `
                        <div class="allocation-grid">
                            ${days.map(day => {
                                const dateStr = day.toISOString().split('T')[0];
                                const dayName = day.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                                const alloc = site.allocation.find(a => a.date.toISOString().split('T')[0] === dateStr);
                                const trips = alloc ? alloc.trips : 0;
                                const isDisabled = site.isSingleTrip && totalAllocatedTrips >= 1 && trips === 0;
                                return `
                                    <div class="day-allocation">
                                        <div class="day-label">${dayName}</div>
                                        <input type="number" class="trip-input" value="${trips}" min="0" max="10" 
                                            data-site-id="${site.id}" data-date-str="${dateStr}" ${isDisabled ? 'disabled' : ''}>
                                    </div>`;
                            }).join('')}
                        </div>` : '<div class="alert alert-warning">Select a date range to allocate trips.</div>'}
                </div>`}).join('');
        }

        function updateSummary() {
            const rate = parseFloat(document.getElementById('mileageRate').value) || 0;
            const target = parseFloat(document.getElementById('targetAmount').value) || 0;
            let totalDistance = sites.reduce((sum, site) => 
                sum + site.allocation.reduce((siteSum, alloc) => siteSum + (site.distance * alloc.trips), 0), 0);
            
            const totalAmount = totalDistance * rate;
            const progress = target > 0 ? Math.min((totalAmount / target) * 100, 100) : 0;
            
            document.getElementById('totalDistance').textContent = `${totalDistance.toFixed(2)} km`;
            document.getElementById('totalAmount').textContent = `RM ${totalAmount.toFixed(2)}`;
            document.getElementById('targetDisplay').textContent = `RM ${target.toFixed(2)}`;
            document.getElementById('progressPercent').textContent = `${progress.toFixed(1)}%`;
            
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${progress}%`;
            if (progress >= 100) progressBar.style.background = 'var(--success-color)';
            else if (progress >= 75) progressBar.style.background = 'var(--warning-color)';
            else progressBar.style.background = 'var(--accent-color)';

            const meetTargetBtn = document.getElementById('meetTargetBtn');
            if (target > 0 && totalAmount > 0 && totalAmount < target) {
                meetTargetBtn.disabled = false;
            } else {
                meetTargetBtn.disabled = true;
            }
        }
    </script>
</body>
</html>
