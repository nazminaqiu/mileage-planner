<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mileage Claim Planner</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg-primary: #ffffff; --bg-secondary: #f8f9fa; --bg-tertiary: #e9ecef; --text-primary: #212529; --text-secondary: #6c757d; --border-color: #dee2e6; --accent-color: #0d6efd; --accent-hover: #0b5ed7; --success-color: #198754; --warning-color: #ffc107; --danger-color: #dc3545; --shadow: 0 2px 8px rgba(0,0,0,0.1); }
        [data-theme="dark"] { --bg-primary: #1a1a1a; --bg-secondary: #2d2d2d; --bg-tertiary: #3a3a3a; --text-primary: #e9ecef; --text-secondary: #adb5bd; --border-color: #495057; --shadow: 0 2px 8px rgba(0,0,0,0.3); }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--bg-secondary); color: var(--text-primary); line-height: 1.6; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: var(--bg-primary); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; font-weight: 600; }
        .theme-toggle { background: var(--bg-tertiary); border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; color: var(--text-primary); font-size: 14px; transition: background-color 0.2s; }
        .theme-toggle:hover { background: var(--border-color); }
        .section { background: var(--bg-primary); padding: 24px; border-radius: 12px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; color: var(--text-primary); }
        input, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-secondary); color: var(--text-primary); transition: border-color 0.2s; }
        input:focus, select:focus { outline: none; border-color: var(--accent-color); }
        .input-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-success { background: var(--success-color); color: white; }
        .btn-success:hover { background: #157347; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-danger:hover { background: #bb2d3b; }
        .btn-group { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }
        .site-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .site-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
        .site-info { flex: 1; }
        .site-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .site-address { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
        .site-distance { font-size: 14px; color: var(--accent-color); font-weight: 500; }
        .allocation-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 12px; }
        .day-allocation { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; text-align: center; }
        .day-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
        .trip-input { width: 100%; padding: 6px; text-align: center; font-size: 14px; font-weight: 600; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px; }
        .summary-card { background: var(--bg-secondary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--accent-color); }
        .summary-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
        .summary-value { font-size: 24px; font-weight: 700; color: var(--text-primary); }
        .progress-bar { width: 100%; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: var(--success-color); transition: width 0.3s; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
        .alert-info { background: rgba(13, 110, 253, 0.1); color: var(--accent-color); border-left: 4px solid var(--accent-color); }
        .alert-warning { background: rgba(255, 193, 7, 0.1); color: var(--warning-color); border-left: 4px solid var(--warning-color); }
        .autocomplete-dropdown { position: absolute; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow); max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%; margin-top: 4px; }
        .autocomplete-item { padding: 10px 12px; cursor: pointer; font-size: 14px; border-bottom: 1px solid var(--border-color); }
        .autocomplete-item:hover { background: var(--bg-secondary); }
        .autocomplete-item:last-child { border-bottom: none; }
        .checkbox-group { display: flex; gap: 20px; align-items: center; }
        .checkbox-label { display: flex; align-items: center; gap: 6px; cursor: pointer; }
        input[type="checkbox"] { width: auto; cursor: pointer; }
        .position-relative { position: relative; }
        @media (max-width: 768px) { .header { flex-direction: column; gap: 12px; } .input-group { grid-template-columns: 1fr; } .allocation-grid { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Mileage Claim Planner</h1>
            <button class="theme-toggle" onclick="toggleTheme()">üåô Toggle Theme</button>
        </div>

        <!-- Configuration -->
        <div class="section">
            <div class="section-title">‚öôÔ∏è Configuration</div>
            <div class="form-group position-relative">
                <label>Start Point (Main Office)</label>
                <input type="text" id="startPoint" placeholder="Enter your office address or use GPS">
                <div id="startPointDropdown" class="autocomplete-dropdown" style="display: none;"></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="useCurrentLocation()">üìç Use Current GPS Location</button>
            </div>
            <div class="input-group">
                <div class="form-group">
                    <label>Mileage Rate (RM/km)</label>
                    <input type="number" id="mileageRate" value="0.80" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Target Amount (RM)</label>
                    <input type="number" id="targetAmount" value="0" step="0.01" min="0">
                </div>
            </div>
            <div class="form-group">
                <label>Date Range</label>
                <input type="text" id="dateRange" placeholder="Select date range">
            </div>
            <div class="form-group">
                <label>Include Weekends</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeSaturday">
                        <span>Saturday</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeSunday">
                        <span>Sunday</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Add Site -->
        <div class="section">
            <div class="section-title">üìç Add Project Site</div>
            <div class="form-group">
                <label>Site Name</label>
                <input type="text" id="siteName" placeholder="e.g., Project Site A">
            </div>
            <div class="form-group position-relative">
                <label>Site Address</label>
                <input type="text" id="siteAddress" placeholder="Start typing to search...">
                <div id="siteAddressDropdown" class="autocomplete-dropdown" style="display: none;"></div>
            </div>
            <button class="btn btn-primary" onclick="addSite()">‚ûï Add Site</button>
        </div>

        <!-- Sites List -->
        <div class="section">
            <div class="section-title">üìã Project Sites</div>
            <div id="sitesList"></div>
        </div>

        <!-- Allocation -->
        <div class="section">
            <div class="section-title">üéØ Smart Allocation</div>
            <div id="allocationAlert"></div>
            <button class="btn btn-success" onclick="autoAllocate()">‚ú® Auto Allocate</button>
            <button class="btn btn-secondary" onclick="clearAllocation()">üóëÔ∏è Clear All</button>
        </div>

        <!-- Summary -->
        <div class="section">
            <div class="section-title">üìä Summary</div>
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-label">Total Distance</div>
                    <div class="summary-value" id="totalDistance">0 km</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Total Amount</div>
                    <div class="summary-value" id="totalAmount">RM 0.00</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Target Amount</div>
                    <div class="summary-value" id="targetDisplay">RM 0.00</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Progress</div>
                    <div class="summary-value" id="progressPercent">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- ========= START: FIRESTORE INTEGRATION ========= -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      // Import Firestore functions
      import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCfq5zOyd0nJQ61durfVvvNals789n4-WE",
        authDomain: "mileage-planner.firebaseapp.com",
        projectId: "mileage-planner",
        storageBucket: "mileage-planner.appspot.com",
        messagingSenderId: "924534923921",
        appId: "1:924534923921:web:866e5cbbd3ae5b04175530"
      };

      const app = initializeApp(firebaseConfig);
      // Initialize Firestore
      const db = getFirestore(app);
      
      // Make Firestore functions and db instance available globally
      window.firestoreDb = {
        db: db,
        doc: doc,
        setDoc: setDoc,
        onSnapshot: onSnapshot
      };

      // Ensure app logic runs AFTER Firebase is ready
      window.loadData();
      window.loadGoogleMapsAPI();
    </script>
    <!-- ========= END: FIRESTORE INTEGRATION ========= -->


    <script>
        // Global variables
        let sites = [];
        let config = { startPoint: '', startPointCoords: null, mileageRate: 0.80, targetAmount: 0, dateRange: { start: null, end: null }, includeSaturday: false, includeSunday: false };
        let apiValidated = false;
        let directionsService, autocompleteService, placesService;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            initializeFlatpickr();
            setupEventListeners();
        });

        window.loadGoogleMapsAPI = function() {
            // !!! IMPORTANT: PASTE YOUR GOOGLE MAPS API KEY HERE !!!
            const apiKey = "AIzaSyAJyhj-tFjwXh66pzEA-Eh7wdwubye3txo";
            
            if (!apiKey || apiKey === "YOUR_GOOGLE_MAPS_API_KEY") {
                alert("Please enter your Google Maps API Key in the script to enable mapping features.");
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places,geometry&callback=initMap`;
            script.async = true;
            script.defer = true;
            script.onerror = () => alert('Failed to load Google Maps API. Check your API key and internet connection.');
            document.head.appendChild(script);
        }

        function initMap() {
            try {
                directionsService = new google.maps.DirectionsService();
                autocompleteService = new google.maps.places.AutocompleteService();
                const tempDiv = document.createElement('div');
                placesService = new google.maps.places.PlacesService(tempDiv);
                apiValidated = true;
                console.log('Google Maps API Initialized Successfully.');
            } catch (error) {
                apiValidated = false;
                alert(`Google Maps API validation failed: ${error.message}`);
            }
        }

        function setupEventListeners() {
            document.getElementById('startPoint').addEventListener('input', handleStartPointInput);
            document.getElementById('siteAddress').addEventListener('input', handleSiteAddressInput);
            document.getElementById('mileageRate').addEventListener('change', saveConfig);
            document.getElementById('targetAmount').addEventListener('change', saveConfig);
            document.getElementById('includeSaturday').addEventListener('change', saveConfig);
            document.getElementById('includeSunday').addEventListener('change', saveConfig);
            document.getElementById('mileageRate').addEventListener('input', updateSummary);
            document.getElementById('targetAmount').addEventListener('input', updateSummary);
        }

        function initializeFlatpickr() {
            flatpickr(document.getElementById('dateRange'), {
                mode: 'range',
                dateFormat: 'Y-m-d',
                onChange: function(selectedDates) {
                    if (selectedDates.length === 2) {
                        config.dateRange.start = new Date(selectedDates[0]);
                        config.dateRange.end = new Date(selectedDates[1]);
                        saveConfig();
                        renderSites();
                        updateSummary();
                    }
                },
            });
        }
        
        function handleStartPointInput(e) { /* ... no changes ... */ if (e.target.value.length < 3 || !apiValidated) return; autocompleteService.getPlacePredictions({ input: e.target.value }, (p, s) => { if (s === google.maps.places.PlacesServiceStatus.OK) showAutocomplete('startPointDropdown', p, selectStartPoint); }); }
        function handleSiteAddressInput(e) { /* ... no changes ... */ if (e.target.value.length < 3 || !apiValidated) return; autocompleteService.getPlacePredictions({ input: e.target.value }, (p, s) => { if (s === google.maps.places.PlacesServiceStatus.OK) showAutocomplete('siteAddressDropdown', p, selectSiteAddress); }); }
        function showAutocomplete(dropdownId, predictions, callback) { /* ... no changes ... */ const d = document.getElementById(dropdownId); d.innerHTML = ''; d.style.display = 'block'; predictions.forEach(p => { const i = document.createElement('div'); i.className = 'autocomplete-item'; i.textContent = p.description; i.onclick = () => callback(p); d.appendChild(i); }); document.addEventListener('click', function c(e) { if (!d.contains(e.target)) { d.style.display = 'none'; document.removeEventListener('click', c); } }); }
        function selectStartPoint(prediction) { /* ... no changes ... */ document.getElementById('startPoint').value = prediction.description; document.getElementById('startPointDropdown').style.display = 'none'; placesService.getDetails({ placeId: prediction.place_id }, (p, s) => { if (s === google.maps.places.PlacesServiceStatus.OK) { config.startPoint = prediction.description; config.startPointCoords = { lat: p.geometry.location.lat(), lng: p.geometry.location.lng() }; saveConfig(); recalculateAllDistances(); } }); }
        function selectSiteAddress(prediction) { /* ... no changes ... */ document.getElementById('siteAddress').value = prediction.description; document.getElementById('siteAddressDropdown').style.display = 'none'; }
        function useCurrentLocation() { /* ... no changes ... */ if (!navigator.geolocation) return alert('Geolocation is not supported'); navigator.geolocation.getCurrentPosition(p => { const c = { lat: p.coords.latitude, lng: p.coords.longitude }; new google.maps.Geocoder().geocode({ location: c }, (r, s) => { if (s === 'OK' && r[0]) { document.getElementById('startPoint').value = r[0].formatted_address; config.startPoint = r[0].formatted_address; config.startPointCoords = c; saveConfig(); recalculateAllDistances(); } }); }, e => alert('Error: ' + e.message)); }
        function addSite() { /* ... no changes ... */ if (!apiValidated) return alert('Maps not ready'); const n = document.getElementById('siteName').value.trim(); const a = document.getElementById('siteAddress').value.trim(); if (!n || !a) return alert('Name and address required'); if (!config.startPoint) return alert('Start point required'); const s = { id: Date.now(), name: n, address: a, distance: 0, allocation: [] }; sites.push(s); calculateDistance(s); document.getElementById('siteName').value = ''; document.getElementById('siteAddress').value = ''; saveData(); renderSites(); }
        function calculateDistance(site) { /* ... no changes ... */ if (!config.startPointCoords) return; placesService.findPlaceFromQuery({ query: site.address, fields: ['geometry'] }, (r, s) => { if (s === google.maps.places.PlacesServiceStatus.OK && r[0]) { directionsService.route({ origin: new google.maps.LatLng(config.startPointCoords.lat, config.startPointCoords.lng), destination: r[0].geometry.location, travelMode: google.maps.TravelMode.DRIVING }, (res, stat) => { if (stat === google.maps.DirectionsStatus.OK) { site.distance = Math.round((res.routes[0].legs[0].distance.value / 1000) * 2 * 100) / 100; saveData(); renderSites(); updateSummary(); } }); } }); }
        function recalculateAllDistances() { /* ... no changes ... */ sites.forEach(calculateDistance); }
        function removeSite(siteId) { /* ... no changes ... */ if (confirm('Remove site?')) { sites = sites.filter(s => s.id !== siteId); saveData(); renderSites(); updateSummary(); } }
        function getDaysInRange() { /* ... no changes ... */ if (!config.dateRange.start) return []; const days = []; const current = new Date(config.dateRange.start); const end = new Date(config.dateRange.end); while (current <= end) { const d = current.getDay(); if ((d !== 6 && d !== 0) || (d === 6 && config.includeSaturday) || (d === 0 && config.includeSunday)) days.push(new Date(current)); current.setDate(current.getDate() + 1); } return days; }
        function autoAllocate() { /* ... no changes ... */ if (sites.length === 0) return alert('Add a site'); if (!config.dateRange.start) return alert('Select date range'); const t = parseFloat(document.getElementById('targetAmount').value) || 0; const r = parseFloat(document.getElementById('mileageRate').value) || 0; if (t <= 0) return alert('Target must be > 0'); const days = getDaysInRange(); if (days.length === 0) return alert('No available days'); sites.forEach(s => s.allocation = []); const sortedSites = [...sites].sort((a, b) => b.distance - a.distance); let amount = 0, index = 0; while (amount < t && index < days.length * 3 * sites.length) { for (const s of sortedSites) { if (amount >= t) break; const day = days[index % days.length]; let alloc = s.allocation.find(a => a.date.getTime() === day.getTime()); if (!alloc) { alloc = { date: new Date(day), trips: 0 }; s.allocation.push(alloc); } if (alloc.trips < 3) { alloc.trips++; amount += s.distance * r; } index++; } } showAllocationAlert(amount < t ? 'warning' : 'info', amount < t ? `Target not met. Shortfall: RM ${(t - amount).toFixed(2)}.` : `Allocation complete! Total: RM ${amount.toFixed(2)}`); saveData(); renderSites(); updateSummary(); }
        function clearAllocation() { /* ... no changes ... */ if (confirm('Clear all allocations?')) { sites.forEach(s => s.allocation = []); saveData(); renderSites(); updateSummary(); } }
        function updateTrips(siteId, dateStr, trips) { /* ... no changes ... */ const s = sites.find(s => s.id === siteId); if (!s) return; const d = new Date(dateStr); let a = s.allocation.find(a => a.date.getTime() === d.getTime()); const num = Math.max(0, parseInt(trips) || 0); if (a) { a.trips = num; } else if (num > 0) { s.allocation.push({ date: d, trips: num }); } if (a && a.trips === 0) { s.allocation = s.allocation.filter(al => al.date.getTime() !== d.getTime()); } saveData(); updateSummary(); }
        function showAllocationAlert(type, message) { /* ... no changes ... */ const a = document.getElementById('allocationAlert'); a.className = `alert alert-${type}`; a.textContent = message; }
        function renderSites() { /* ... no changes ... */ const c = document.getElementById('sitesList'); if (sites.length === 0) { c.innerHTML = '<div class="alert alert-info">No sites added.</div>'; return; } const days = getDaysInRange(); c.innerHTML = sites.map(s => `<div class="site-card"><div class="site-header"><div class="site-info"><div class="site-name">${s.name}</div><div class="site-address">${s.address}</div><div class="site-distance">${s.distance > 0 ? `${s.distance} km (round-trip)` : 'Calculating...'}</div></div><button class="btn btn-danger" onclick="removeSite(${s.id})">‚úï</button></div>${days.length > 0 ? `<div class="allocation-grid">${days.map(d => { const ds = d.toISOString().split('T')[0]; const dn = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }); const a = s.allocation.find(al => al.date.toISOString().split('T')[0] === ds); const t = a ? a.trips : 0; return `<div class="day-allocation"><div class="day-label">${dn}</div><input type="number" class="trip-input" value="${t}" min="0" max="10" onchange="updateTrips(${s.id}, '${ds}', this.value)"></div>`; }).join('')}</div>` : '<div class="alert alert-warning">Select a date range</div>'}</div>`).join(''); }
        function updateSummary() { /* ... no changes ... */ const r = parseFloat(document.getElementById('mileageRate').value) || 0; const t = parseFloat(document.getElementById('targetAmount').value) || 0; const dist = sites.reduce((sum, s) => sum + s.allocation.reduce((ss, a) => ss + s.distance * a.trips, 0), 0); const amount = dist * r; const prog = t > 0 ? Math.min((amount / t) * 100, 100) : 0; document.getElementById('totalDistance').textContent = `${dist.toFixed(2)} km`; document.getElementById('totalAmount').textContent = `RM ${amount.toFixed(2)}`; document.getElementById('targetDisplay').textContent = `RM ${t.toFixed(2)}`; document.getElementById('progressPercent').textContent = `${prog.toFixed(1)}%`; const p = document.getElementById('progressBar'); p.style.width = `${prog}%`; p.style.background = prog >= 100 ? 'var(--success-color)' : prog >= 75 ? 'var(--warning-color)' : 'var(--accent-color)'; }
        function saveConfig() { /* ... no changes ... */ config.mileageRate = parseFloat(document.getElementById('mileageRate').value) || 0; config.targetAmount = parseFloat(document.getElementById('targetAmount').value) || 0; config.includeSaturday = document.getElementById('includeSaturday').checked; config.includeSunday = document.getElementById('includeSunday').checked; saveData(); }
        function toggleTheme() { /* ... no changes ... */ const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); }
        function loadTheme() { /* ... no changes ... */ document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light'); }

        // ===================================================================
        // ===== FIRESTORE DATA FUNCTIONS (REPLACING REALTIME DB) ======
        // ===================================================================

        function saveData() {
            if (!window.firestoreDb) return console.error("Firestore is not initialized.");
            
            // Define the document reference
            const docRef = window.firestoreDb.doc(window.firestoreDb.db, "plannerData", "sharedState");

            // Prepare data for saving (convert Dates to strings)
            const dataToSave = {
                sites: sites.map(site => ({ ...site, allocation: site.allocation.map(alloc => ({ ...alloc, date: alloc.date.toISOString() })) })),
                config: { ...config, dateRange: { start: config.dateRange.start?.toISOString() || null, end: config.dateRange.end?.toISOString() || null } }
            };

            // Use setDoc to create or overwrite the document
            window.firestoreDb.setDoc(docRef, dataToSave)
                .catch(error => console.error("Firestore save error:", error));
        }

        window.loadData = function() {
            if (!window.firestoreDb) return console.error("Firestore is not initialized.");

            // Define the document reference
            const docRef = window.firestoreDb.doc(window.firestoreDb.db, "plannerData", "sharedState");

            // Use onSnapshot to listen for real-time changes
            window.firestoreDb.onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    config = data.config || {};
                    if (config.dateRange?.start) config.dateRange.start = new Date(config.dateRange.start);
                    if (config.dateRange?.end) config.dateRange.end = new Date(config.dateRange.end);
                    
                    sites = (data.sites || []).map(site => ({ ...site, allocation: (site.allocation || []).map(alloc => ({ ...alloc, date: new Date(alloc.date) })) }));

                    // Update UI with loaded data
                    document.getElementById('startPoint').value = config.startPoint || '';
                    document.getElementById('mileageRate').value = config.mileageRate || 0.80;
                    document.getElementById('targetAmount').value = config.targetAmount || 0;
                    document.getElementById('includeSaturday').checked = config.includeSaturday || false;
                    document.getElementById('includeSunday').checked = config.includeSunday || false;
                    
                    const fp = document.getElementById('dateRange')._flatpickr;
                    if (fp && config.dateRange?.start) {
                        fp.setDate([config.dateRange.start, config.dateRange.end], false);
                    }
                    
                    renderSites();
                    updateSummary();
                } else {
                    console.log("No shared data found in Firestore. A new document will be created on the first save.");
                }
            });
        }
    </script>
</body>
</html>
