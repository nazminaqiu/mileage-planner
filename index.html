<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mileage Claim Planner</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #0d6efd;
            --accent-hover: #0b5ed7;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --border-color: #495057;
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .theme-toggle:hover {
            background: var(--border-color);
        }

        .section {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-success {
            background: rgba(25, 135, 84, 0.1);
            color: var(--success-color);
        }

        .status-error {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }
        
        input:disabled {
            background-color: var(--bg-tertiary);
            cursor: not-allowed;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #157347;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #bb2d3b;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .site-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .site-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .site-info {
            flex: 1;
        }

        .site-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .site-address {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .site-distance {
            font-size: 14px;
            color: var(--accent-color);
            font-weight: 500;
        }

        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .day-allocation {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }

        .day-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .trip-input {
            width: 100%;
            padding: 6px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .summary-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--success-color);
            transition: width 0.3s;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-info {
            background: rgba(13, 110, 253, 0.1);
            color: var(--accent-color);
            border-left: 4px solid var(--accent-color);
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }

        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-tertiary);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .autocomplete-dropdown {
            position: absolute;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            margin-top: 4px;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid var(--border-color);
        }

        .autocomplete-item:hover {
            background: var(--bg-secondary);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .position-relative {
            position: relative;
        }
        
        .remove-site-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 24px;
            text-align: center;
        }
        .remove-site-btn:hover {
            background: #bb2d3b;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 12px;
            }

            .input-group {
                grid-template-columns: 1fr;
            }

            .allocation-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 Mileage Claim Planner</h1>
            <button id="themeToggleBtn" class="theme-toggle">🌙 Toggle Theme</button>
        </div>

        <!-- API Status -->
        <div id="apiStatus" class="section">
            <div class="section-title">
                API Status
                <span id="apiStatusBadge" class="status-badge">Waiting for API Key</span>
            </div>
            <div id="apiKeyInput" style="display: block;">
                <div class="alert alert-info">
                    Please enter your Google Maps API Key to get started. Your key will be saved securely in your browser.
                </div>
                <div class="form-group">
                    <label>Google Maps API Key</label>
                    <input type="text" id="apiKeyField" placeholder="Enter your API key here">
                </div>
                <button id="validateApiKeyBtn" class="btn btn-primary">🔑 Validate & Save API Key</button>
                <button id="apiKeyHelpBtn" class="btn btn-secondary">❓ How to get API Key</button>
            </div>
            <div id="apiMessage" class="alert alert-info" style="display: none;">
                Validating Google Maps API...
            </div>
        </div>

        <!-- Configuration -->
        <div class="section">
            <div class="section-title">⚙️ Configuration</div>
            
            <div class="form-group position-relative">
                <label>Start Point (Main Office)</label>
                <input type="text" id="startPoint" placeholder="Enter your office address or use GPS">
                <div id="startPointDropdown" class="autocomplete-dropdown" style="display: none;"></div>
            </div>
            
            <div class="btn-group">
                <button id="useGpsBtn" class="btn btn-secondary">📍 Use Current GPS Location</button>
            </div>

            <div class="input-group">
                <div class="form-group">
                    <label>Mileage Rate (RM/km)</label>
                    <input type="number" id="mileageRate" value="0.80" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Target Amount (RM)</label>
                    <input type="number" id="targetAmount" value="0" step="0.01" min="0">
                </div>
            </div>

            <div class="form-group">
                <label>Date Range</label>
                <input type="text" id="dateRange" placeholder="Select date range">
            </div>

            <div class="form-group">
                <label>Include Weekends</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeSaturday">
                        <span>Saturday</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeSunday">
                        <span>Sunday</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Add Site -->
        <div class="section">
            <div class="section-title">📍 Add Project Site</div>
            
            <div class="form-group">
                <label>Site Name</label>
                <input type="text" id="siteName" placeholder="e.g., Project Site A">
            </div>

            <div class="form-group position-relative">
                <label>Site Address</label>
                <input type="text" id="siteAddress" placeholder="Start typing to search...">
                <div id="siteAddressDropdown" class="autocomplete-dropdown" style="display: none;"></div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="isSingleTripCheckbox">
                        <span>Single Trip Only (within date range)</span>
                    </label>
                </div>
            </div>

            <button id="addSiteBtn" class="btn btn-primary">➕ Add Site</button>
        </div>

        <!-- Sites List -->
        <div class="section">
            <div class="section-title">📋 Project Sites</div>
            <div id="sitesList"></div>
        </div>

        <!-- Allocation -->
        <div class="section">
            <div class="section-title">🎯 Smart Allocation</div>
            <div id="allocationAlert"></div>
            <button id="autoAllocateBtn" class="btn btn-success">✨ Auto Allocate</button>
            <button id="clearAllocationBtn" class="btn btn-secondary">🗑️ Clear All</button>
        </div>

        <!-- Summary -->
        <div class="section">
            <div class="section-title">📊 Summary</div>

            <div class="btn-group" style="margin-top: 0; margin-bottom: 24px;">
                <button id="exportCsvBtn" class="btn btn-secondary">📄 Export to CSV</button>
            </div>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-label">Total Distance</div>
                    <div class="summary-value" id="totalDistance">0 km</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Total Amount</div>
                    <div class="summary-value" id="totalAmount">RM 0.00</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Target Amount</div>
                    <div class="summary-value" id="targetDisplay">RM 0.00</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Progress</div>
                    <div class="summary-value" id="progressPercent">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import flatpickr from "https://cdn.jsdelivr.net/npm/flatpickr/+esm";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfq5zOyd0nJQ61durfVvvNals789n4-WE",
            authDomain: "mileage-planner.firebaseapp.com",
            databaseURL: "https://mileage-planner-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mileage-planner",
            storageBucket: "mileage-planner.appspot.com",
            messagingSenderId: "924534923921",
            appId: "1:924534923921:web:866e5cbbd3ae5b04175530",
            measurementId: "G-6547J3HQ67"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        let directionsService, autocompleteService, placesService;
        let sites = [];
        let config = {
            startPoint: '',
            startPointCoords: null,
            mileageRate: 0.80,
            targetAmount: 0,
            dateRange: { start: null, end: null },
            includeSaturday: false,
            includeSunday: false
        };
        let apiKey = '';
        let apiValidated = false;

        function toFirestore(data) {
            const firestoreData = { ...data };
            if (firestoreData.dateRange) {
                firestoreData.dateRange.start = firestoreData.dateRange.start ? firestoreData.dateRange.start.toISOString() : null;
                firestoreData.dateRange.end = firestoreData.dateRange.end ? firestoreData.dateRange.end.toISOString() : null;
            }
            if (firestoreData.allocation) {
                firestoreData.allocation = firestoreData.allocation.map(a => ({ ...a, date: a.date.toISOString() }));
            }
            return firestoreData;
        }

        function fromFirestore(data) {
            const localData = { ...data };
            if (localData.dateRange) {
                localData.dateRange.start = localData.dateRange.start ? new Date(localData.dateRange.start) : null;
                localData.dateRange.end = localData.dateRange.end ? new Date(localData.dateRange.end) : null;
            }
             if (localData.allocation) {
                localData.allocation = localData.allocation.map(a => ({ ...a, date: new Date(a.date) }));
            }
            return localData;
        }

        async function saveConfig() {
            config.mileageRate = parseFloat(document.getElementById('mileageRate').value) || 0;
            config.targetAmount = parseFloat(document.getElementById('targetAmount').value) || 0;
            config.includeSaturday = document.getElementById('includeSaturday').checked;
            config.includeSunday = document.getElementById('includeSunday').checked;
            
            try { await setDoc(doc(db, 'plannerData', 'config'), toFirestore(config)); } 
            catch(e) { console.error("Error saving config:", e); }
            
            renderSites();
            updateSummary();
        }

        async function saveSite(site) {
             try { await setDoc(doc(db, 'sites', site.id.toString()), toFirestore(site)); } 
             catch(e) { console.error("Error saving site:", e); }
        }

        async function loadData() {
            try {
                const configSnap = await getDoc(doc(db, 'plannerData', 'config'));
                if (configSnap.exists()) {
                    config = fromFirestore(configSnap.data());
                    document.getElementById('startPoint').value = config.startPoint || '';
                    document.getElementById('mileageRate').value = config.mileageRate;
                    document.getElementById('targetAmount').value = config.targetAmount;
                    document.getElementById('includeSaturday').checked = config.includeSaturday;
                    document.getElementById('includeSunday').checked = config.includeSunday;
                    if (config.dateRange.start && config.dateRange.end) {
                        document.getElementById('dateRange')._flatpickr.setDate([config.dateRange.start, config.dateRange.end]);
                    }
                }
                const sitesSnap = await getDocs(collection(db, 'sites'));
                sites = sitesSnap.docs.map(d => fromFirestore(d.data()));
                renderSites();
                updateSummary();
            } catch(e) { console.error("Error loading data:", e); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            initializeFlatpickr();
            setupEventListeners();
            checkForAPIKey(); 
        });

        function setupEventListeners() {
            document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);
            document.getElementById('validateApiKeyBtn').addEventListener('click', validateAndSaveAPIKey);
            document.getElementById('apiKeyHelpBtn').addEventListener('click', showAPIKeyHelp);
            document.getElementById('useGpsBtn').addEventListener('click', useCurrentLocation);
            document.getElementById('addSiteBtn').addEventListener('click', addSite);
            document.getElementById('autoAllocateBtn').addEventListener('click', autoAllocate);
            document.getElementById('clearAllocationBtn').addEventListener('click', clearAllocation);
            document.getElementById('startPoint').addEventListener('input', handleStartPointInput);
            document.getElementById('siteAddress').addEventListener('input', handleSiteAddressInput);
            document.getElementById('mileageRate').addEventListener('change', saveConfig);
            document.getElementById('targetAmount').addEventListener('change', saveConfig);
            document.getElementById('includeSaturday').addEventListener('change', saveConfig);
            document.getElementById('includeSunday').addEventListener('change', saveConfig);
            document.getElementById('mileageRate').addEventListener('input', updateSummary);
            document.getElementById('targetAmount').addEventListener('input', updateSummary);
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);

            const sitesList = document.getElementById('sitesList');
            sitesList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('remove-site-btn')) {
                    await removeSite(parseInt(e.target.dataset.siteId));
                }
            });

            sitesList.addEventListener('change', async (e) => {
                 if (e.target.classList.contains('trip-input')) {
                    await updateTrips(parseInt(e.target.dataset.siteId), e.target.dataset.dateStr, e.target.value);
                }
                if (e.target.classList.contains('single-trip-toggle')) {
                    await toggleSiteSingleTripStatus(parseInt(e.target.dataset.siteId), e.target.checked);
                }
            });
        }
        
        async function toggleSiteSingleTripStatus(siteId, isSingleTrip) {
            const site = sites.find(s => s.id === siteId);
            if (!site) return;
            site.isSingleTrip = isSingleTrip;
            await saveSite(site);
            renderSites();
        }
        
        function toggleTheme() {
            const html = document.documentElement;
            const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function loadTheme() {
            document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');
        }

        function checkForAPIKey() {
            const savedKey = localStorage.getItem('googleMapsApiKey');
            if (savedKey) {
                apiKey = savedKey;
                document.getElementById('apiKeyInput').style.display = 'none';
                document.getElementById('apiMessage').style.display = 'block';
                loadGoogleMapsAPI();
            }
        }

        function validateAndSaveAPIKey() {
            const keyInput = document.getElementById('apiKeyField').value.trim();
            if (!keyInput) { alert('Please enter an API key'); return; }
            apiKey = keyInput;
            localStorage.setItem('googleMapsApiKey', apiKey);
            document.getElementById('apiKeyInput').style.display = 'none';
            document.getElementById('apiMessage').style.display = 'block';
            loadGoogleMapsAPI();
        }

        function showAPIKeyHelp() {
            alert(`How to get Google Maps API Key...`);
        }

        function loadGoogleMapsAPI() {
            if (window.google) return;
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places,geometry&callback=initMap`;
            script.async = true;
            script.defer = true;
            script.onerror = () => updateAPIStatus(false, 'Failed to load Google Maps API.');
            window.initMap = initMap;
            document.head.appendChild(script);
        }
        
        async function initMap() {
            try {
                directionsService = new google.maps.DirectionsService();
                autocompleteService = new google.maps.places.AutocompleteService();
                placesService = new google.maps.places.PlacesService(document.createElement('div'));
                apiValidated = true;
                updateAPIStatus(true, 'Google Maps API validated!');
                await loadData();
            } catch (error) {
                apiValidated = false;
                updateAPIStatus(false, `API validation failed: ${error.message}`);
            }
        }

        function updateAPIStatus(success, message) {
            const badge = document.getElementById('apiStatusBadge');
            const messageEl = document.getElementById('apiMessage');
            badge.className = success ? 'status-badge status-success' : 'status-badge status-error';
            badge.textContent = success ? 'Connected' : 'Error';
            messageEl.className = success ? 'alert alert-info' : 'alert alert-danger';
            messageEl.textContent = message;
        }

        function initializeFlatpickr() {
            document.getElementById('dateRange')._flatpickr = flatpickr("#dateRange", {
                mode: 'range',
                dateFormat: 'Y-m-d',
                onChange: (selectedDates) => {
                    if (selectedDates.length === 2) {
                        config.dateRange.start = selectedDates[0];
                        config.dateRange.end = selectedDates[1];
                        saveConfig();
                    }
                },
            });
        }
        
        function handleStartPointInput(e) {
            if (e.target.value.length < 3 || !apiValidated) return;
            autocompleteService.getPlacePredictions({ input: e.target.value }, (p, s) => {
                if (s === 'OK') showAutocomplete('startPointDropdown', p, selectStartPoint);
            });
        }

        function handleSiteAddressInput(e) {
            if (e.target.value.length < 3 || !apiValidated) return;
            autocompleteService.getPlacePredictions({ input: e.target.value }, (p, s) => {
                if (s === 'OK') showAutocomplete('siteAddressDropdown', p, selectSiteAddress);
            });
        }

        function showAutocomplete(dropdownId, predictions, callback) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.innerHTML = '';
            dropdown.style.display = 'block';
            predictions.forEach(p => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = p.description;
                item.onclick = () => callback(p);
                dropdown.appendChild(item);
            });
            document.addEventListener('click', e => {
                if (!dropdown.contains(e.target)) dropdown.style.display = 'none';
            }, { once: true });
        }

        function selectStartPoint(prediction) {
            document.getElementById('startPoint').value = prediction.description;
            document.getElementById('startPointDropdown').style.display = 'none';
            placesService.getDetails({ placeId: prediction.place_id }, (place, status) => {
                if (status === 'OK') {
                    config.startPoint = prediction.description;
                    config.startPointCoords = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
                    saveConfig();
                    recalculateAllDistances();
                }
            });
        }

        function selectSiteAddress(prediction) {
            document.getElementById('siteAddress').value = prediction.description;
            document.getElementById('siteAddressDropdown').style.display = 'none';
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) return alert('Geolocation not supported.');
            navigator.geolocation.getCurrentPosition(pos => {
                const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                (new google.maps.Geocoder()).geocode({ location: coords }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        document.getElementById('startPoint').value = results[0].formatted_address;
                        config.startPoint = results[0].formatted_address;
                        config.startPointCoords = coords;
                        saveConfig();
                        recalculateAllDistances();
                    }
                });
            }, err => alert(`Geolocation error: ${err.message}`));
        }

        async function addSite() {
            if (!apiValidated) return alert('API not validated.');
            const name = document.getElementById('siteName').value.trim();
            const address = document.getElementById('siteAddress').value.trim();
            const isSingleTrip = document.getElementById('isSingleTripCheckbox').checked;

            if (!name || !address) return alert('Please enter site name and address.');
            if (!config.startPoint) return alert('Please set a start point.');

            const site = { id: Date.now(), name, address, distance: 0, allocation: [], isSingleTrip };
            sites.push(site);

            document.getElementById('siteName').value = '';
            document.getElementById('siteAddress').value = '';
            document.getElementById('isSingleTripCheckbox').checked = false;

            renderSites();
            await calculateDistance(site);
        }

        function calculateDistance(site) {
             return new Promise((resolve, reject) => {
                if (!config.startPointCoords) return reject(new Error('Start point not set.'));
                placesService.findPlaceFromQuery({ query: site.address, fields: ['geometry'] }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        directionsService.route({
                            origin: config.startPointCoords,
                            destination: results[0].geometry.location,
                            travelMode: google.maps.TravelMode.DRIVING
                        }, async (result, status) => {
                            if (status === 'OK') {
                                site.distance = Math.round((result.routes[0].legs[0].distance.value / 1000) * 2 * 100) / 100;
                                await saveSite(site);
                                renderSites();
                                updateSummary();
                                resolve();
                            } else { reject(new Error('Directions service failed.')); }
                        });
                    } else { reject(new Error('Place not found.')); }
                });
            });
        }

        async function recalculateAllDistances() {
            for (const site of sites) await calculateDistance(site);
        }

        async function removeSite(siteId) {
            if (confirm('Are you sure you want to remove this site?')) {
                sites = sites.filter(s => s.id !== siteId);
                await deleteDoc(doc(db, 'sites', String(siteId)));
                renderSites();
                updateSummary();
            }
        }

        function getDaysInRange() {
            if (!config.dateRange.start || !config.dateRange.end) return [];
            const days = [];
            let current = new Date(config.dateRange.start);
            const end = new Date(config.dateRange.end);
            while (current <= end) {
                const dayOfWeek = current.getDay();
                if ((dayOfWeek !== 0 && dayOfWeek !== 6) || (dayOfWeek === 6 && config.includeSaturday) || (dayOfWeek === 0 && config.includeSunday)) {
                    days.push(new Date(current));
                }
                current.setDate(current.getDate() + 1);
            }
            return days;
        }

        // MODIFIED: New two-phase allocation logic
        async function autoAllocate() {
            if (sites.length === 0) return alert('Please add at least one site.');
            if (!config.dateRange.start) return alert('Please select a date range.');
            const target = parseFloat(document.getElementById('targetAmount').value) || 0;
            const rate = parseFloat(document.getElementById('mileageRate').value) || 0;
            if (target <= 0) return alert('Please set a target amount > 0.');
            const days = getDaysInRange();
            if (days.length === 0) return alert('No available days in range.');
            
            sites.forEach(site => site.allocation = []);
            let currentAmount = 0;
            const maxTripsPerDay = 3;

            // Separate sites into long and short trip categories
            const longTripSites = sites.filter(s => s.distance > 100).sort((a, b) => b.distance - a.distance);
            const shortTripSites = sites.filter(s => s.distance <= 100).sort((a, b) => b.distance - a.distance);

            // Keep track of how many trips are on each day
            const dayUsage = new Map();
            days.forEach(day => dayUsage.set(day.getTime(), 0));

            // --- PHASE 1: Allocate all possible short trips first ---
            let shortTripIndex = 0;
            while (currentAmount < target && shortTripIndex < days.length * shortTripSites.length * maxTripsPerDay) {
                let tripAdded = false;
                for (const site of shortTripSites) {
                    if (currentAmount >= target) break;

                    const hasExistingTrip = site.allocation.some(a => a.trips > 0);
                    if (site.isSingleTrip && hasExistingTrip) continue;

                    const day = days[shortTripIndex % days.length];
                    const dayTimestamp = day.getTime();
                    
                    if (dayUsage.get(dayTimestamp) < maxTripsPerDay) {
                        let dayAlloc = site.allocation.find(a => a.date.getTime() === dayTimestamp);
                        if (!dayAlloc) {
                            dayAlloc = { date: day, trips: 0 };
                            site.allocation.push(dayAlloc);
                        }
                        dayAlloc.trips++;
                        dayUsage.set(dayTimestamp, dayUsage.get(dayTimestamp) + 1);
                        currentAmount += site.distance * rate;
                        tripAdded = true;
                    }
                    shortTripIndex++;
                }
                if (!tripAdded && shortTripIndex > days.length * shortTripSites.length) break; // Exit if no progress
            }

            // --- PHASE 2: Fill remaining empty days with long trips ---
            if (currentAmount < target) {
                const emptyDays = days.filter(day => dayUsage.get(day.getTime()) === 0);
                let emptyDayIndex = 0;
                for (const site of longTripSites) {
                    if (currentAmount >= target) break;
                    if (emptyDayIndex >= emptyDays.length) break;

                    const hasExistingTrip = site.allocation.some(a => a.trips > 0);
                    if (site.isSingleTrip && hasExistingTrip) continue;

                    const day = emptyDays[emptyDayIndex];
                    let dayAlloc = { date: day, trips: 1 };
                    site.allocation.push(dayAlloc);
                    currentAmount += site.distance * rate;
                    emptyDayIndex++;
                }
            }
            
            const batch = writeBatch(db);
            sites.forEach(site => batch.set(doc(db, 'sites', String(site.id)), toFirestore(site)));
            await batch.commit();

            if (currentAmount < target) {
                showAllocationAlert('warning', `Target not fully met. Shortfall: RM ${(target - currentAmount).toFixed(2)}.`);
            } else {
                showAllocationAlert('info', `Allocation complete! Total: RM ${currentAmount.toFixed(2)}.`);
            }
            renderSites();
            updateSummary();
        }

        async function clearAllocation() {
            if (confirm('Clear all trip allocations?')) {
                sites.forEach(site => site.allocation = []);
                const batch = writeBatch(db);
                sites.forEach(site => batch.set(doc(db, 'sites', String(site.id)), toFirestore(site)));
                await batch.commit();
                renderSites();
                updateSummary();
            }
        }

        async function updateTrips(siteId, dateStr, trips) {
            const site = sites.find(s => s.id === siteId);
            if (!site) return;
            const date = new Date(dateStr);
            const numTrips = Math.max(0, parseInt(trips) || 0);

            let dayAlloc = site.allocation.find(a => a.date.getTime() === date.getTime());
            if (numTrips > 0) {
                 if (!dayAlloc) site.allocation.push({ date, trips: numTrips });
                 else dayAlloc.trips = numTrips;
            } else {
                site.allocation = site.allocation.filter(a => a.date.getTime() !== date.getTime());
            }
            await saveSite(site);
            renderSites();
            updateSummary();
        }

        function showAllocationAlert(type, message) {
            const alertDiv = document.getElementById('allocationAlert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
        }

        function exportToCsv() {
            const claimEntries = [];
            const mileageRate = parseFloat(document.getElementById('mileageRate').value) || 0;

            sites.forEach(site => {
                site.allocation.forEach(alloc => {
                    if (alloc.trips > 0) {
                        const totalDistance = site.distance * alloc.trips;
                        const totalAmount = totalDistance * mileageRate;
                        claimEntries.push({
                            date: alloc.date,
                            siteName: site.name,
                            siteAddress: site.address,
                            trips: alloc.trips,
                            distancePerTrip: site.distance,
                            totalDistanceForDay: totalDistance.toFixed(2),
                            mileageRate: mileageRate.toFixed(2),
                            totalAmountForDay: totalAmount.toFixed(2)
                        });
                    }
                });
            });

            if (claimEntries.length === 0) {
                alert('No claim entries to export. Please allocate some trips first.');
                return;
            }

            claimEntries.sort((a, b) => a.date - b.date);

            const headers = [
                'Date', 'Site Name', 'Site Address', 'Trips', 
                'Distance per Trip (km)', 'Total Distance for Day (km)', 
                'Mileage Rate (RM/km)', 'Total Amount for Day (RM)'
            ];

            const csvRows = claimEntries.map(entry => {
                const formattedDate = entry.date.toISOString().split('T')[0];
                const row = [
                    formattedDate, entry.siteName, entry.siteAddress, entry.trips,
                    entry.distancePerTrip, entry.totalDistanceForDay,
                    entry.mileageRate, entry.totalAmountForDay
                ];
                return row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',');
            });

            const csvContent = [headers.join(','), ...csvRows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `mileage-claim-${today}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function renderSites() {
            const container = document.getElementById('sitesList');
            if (sites.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No sites added yet.</div>';
                return;
            }
            const days = getDaysInRange();
            container.innerHTML = sites.sort((a,b) => a.name.localeCompare(b.name)).map(site => {
                const totalAllocatedTrips = site.allocation.reduce((acc, a) => acc + a.trips, 0);
                return `
                <div class="site-card">
                    <div class="site-header">
                        <div class="site-info">
                            <div class="site-name">${site.name}</div>
                            <div class="site-address">${site.address}</div>
                            <div class="site-distance">${site.distance > 0 ? `${site.distance} km (round-trip)` : '<span class="loading"></span>'}</div>
                            <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
                                <label class="checkbox-label">
                                    <input type="checkbox" class="single-trip-toggle" data-site-id="${site.id}" ${site.isSingleTrip ? 'checked' : ''}>
                                    <span>Single Trip Only</span>
                                </label>
                            </div>
                        </div>
                        <button class="remove-site-btn" data-site-id="${site.id}">✕</button>
                    </div>
                    ${days.length > 0 ? `
                        <div class="allocation-grid">
                            ${days.map(day => {
                                const dateStr = day.toISOString().split('T')[0];
                                const dayName = day.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                                const alloc = site.allocation.find(a => a.date.toISOString().split('T')[0] === dateStr);
                                const trips = alloc ? alloc.trips : 0;
                                const isDisabled = site.isSingleTrip && totalAllocatedTrips >= 1 && trips === 0;
                                return `
                                    <div class="day-allocation">
                                        <div class="day-label">${dayName}</div>
                                        <input type="number" class="trip-input" value="${trips}" min="0" max="10" 
                                            data-site-id="${site.id}" data-date-str="${dateStr}" ${isDisabled ? 'disabled' : ''}>
                                    </div>`;
                            }).join('')}
                        </div>` : '<div class="alert alert-warning">Select a date range to allocate trips.</div>'}
                </div>`}).join('');
        }

        function updateSummary() {
            const rate = parseFloat(document.getElementById('mileageRate').value) || 0;
            const target = parseFloat(document.getElementById('targetAmount').value) || 0;
            let totalDistance = sites.reduce((sum, site) => 
                sum + site.allocation.reduce((siteSum, alloc) => siteSum + (site.distance * alloc.trips), 0), 0);
            
            const totalAmount = totalDistance * rate;
            const progress = target > 0 ? Math.min((totalAmount / target) * 100, 100) : 0;
            
            document.getElementById('totalDistance').textContent = `${totalDistance.toFixed(2)} km`;
            document.getElementById('totalAmount').textContent = `RM ${totalAmount.toFixed(2)}`;
            document.getElementById('targetDisplay').textContent = `RM ${target.toFixed(2)}`;
            document.getElementById('progressPercent').textContent = `${progress.toFixed(1)}%`;
            
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${progress}%`;
            if (progress >= 100) progressBar.style.background = 'var(--success-color)';
            else if (progress >= 75) progressBar.style.background = 'var(--warning-color)';
            else progressBar.style.background = 'var(--accent-color)';
        }
    </script>
</body>
</html>